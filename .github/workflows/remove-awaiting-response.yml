name: Remove Awaiting Response Label on Author Activity

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  pull_request:
    types: [synchronize]  # When author pushes new commits

permissions:
  issues: write
  pull-requests: write

jobs:
  remove-awaiting-response:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            const issue = context.issue || context.payload.pull_request;
            const commenter = context.payload.comment?.user.login || context.payload.sender.login;
            const issueAuthor = context.payload.issue?.user.login || context.payload.pull_request?.user.login;

            // Only proceed if activity is from the issue/PR author
            if (commenter === issueAuthor) {
              const { data: labels } = await github.rest.issues.listLabelsOnIssue({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number
              });

              const hasAwaitingResponse = labels.some(
                label => label.name === 'status: awaiting-response'
              );

              if (hasAwaitingResponse) {
                // Remove "awaiting-response"
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  name: 'status: awaiting-response'
                }).catch(() => {}); // Ignore if label doesn't exist

                // Add "needs-review"
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  labels: ['status: needs-review']
                });

                console.log('Author responded - moved from awaiting-response to needs-review');
              }
            }
